name: Build Nokia XG-040G-MD (Kernel 6.12)

on:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/openwrt/openwrt
  REPO_BRANCH: main
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Build Environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
          gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget
        sudo timedatectl set-timezone "$TZ"

    - name: Clone Source Code
      run: |
        git clone $REPO_URL -b $REPO_BRANCH openwrt

    - name: Add Nokia Device Support
      run: |
        cd openwrt
        
        # 1. 创建设备树文件 (DTS)
        # 这里我们将上面定义好的 DTS 写入源码树
        cat <<EOF > target/linux/airoha/dts/an7581-nokia-xg-040g-md.dts
        /dts-v1/;
        #include "an7581.dtsi"
        / {
            model = "Nokia Bell XG-040G-MD";
            compatible = "nokia,xg-040g-md", "airoha,an7581";
            aliases { serial0 = &uart0; };
            chosen { stdout-path = "serial0:115200n8"; };
            memory@40000000 { device_type = "memory"; reg = <0x0 0x40000000 0x0 0x20000000>; };
        };
        &uart0 { status = "okay"; };
        &spi_nand {
            status = "okay";
            pinctrl-names = "default";
            pinctrl-0 = <&spi_nand_pins>;
            spi_nand@0 {
                compatible = "spi-nand"; reg = <0>; spi-max-frequency = <52000000>;
                partitions {
                    compatible = "fixed-partitions"; #address-cells = <1>; #size-cells = <1>;
                    partition@0 { label = "u-boot"; reg = <0x0 0x100000>; read-only; };
                    partition@100000 { label = "u-boot-env"; reg = <0x100000 0x80000>; };
                    partition@180000 { label = "factory"; reg = <0x180000 0x200000>; read-only; };
                    partition@380000 { label = "firmware"; reg = <0x380000 0xFC80000>; };
                };
            };
        };
        &eth0 { status = "okay"; };
        EOF

        # 2. 注册新设备到 Makefile
        # 定义生成 sysupgrade.itb 和 initramfs-kernel.bin
        cat <<EOF >> target/linux/airoha/image/Makefile
        
        define Device/nokia_xg-040g-md
          DEVICE_VENDOR := Nokia
          DEVICE_MODEL := XG-040G-MD
          DEVICE_DTS := an7581-nokia-xg-040g-md
          BLOCKSIZE := 128k
          PAGESIZE := 2048
          KERNEL := kernel-bin | lzma | fit lzma $$(KDIR)/image-$$(firstword $$(DEVICE_DTS)).dtb
          KERNEL_INITRAMFS := kernel-bin | lzma | fit lzma $$(KDIR)/image-$$(firstword $$(DEVICE_DTS)).dtb
          IMAGES := sysupgrade.itb
          IMAGE/sysupgrade.itb := append-kernel | fit-uimage-nand
        endef
        TARGET_DEVICES += nokia_xg-040g-md
        EOF

    - name: Update Feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Configure Firmware
      run: |
        cd openwrt
        # 生成配置
        cat <<EOF > .config
        CONFIG_TARGET_airoha=y
        CONFIG_TARGET_airoha_an7581=y
        CONFIG_TARGET_airoha_an7581_DEVICE_nokia_xg-040g-md=y
        CONFIG_DEVEL=y
        # 基础软件包
        CONFIG_PACKAGE_luci=y
        CONFIG_PACKAGE_luci-ssl=y
        CONFIG_PACKAGE_uhttpd=y
        CONFIG_PACKAGE_uhttpd-mod-ubus=y
        # U-Boot 工具 (方便在系统内查看环境变量)
        CONFIG_PACKAGE_uboot-envtools=y
        EOF
        
        make defconfig

    - name: Download Sources
      run: |
        cd openwrt
        make download -j8

    - name: Build Firmware
      run: |
        cd openwrt
        echo "Building with $(nproc) threads..."
        make -j$(nproc) || make -j1 V=s

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Nokia_XG-040G-MD_Firmware
        path: openwrt/bin/targets/airoha/an7581/*
